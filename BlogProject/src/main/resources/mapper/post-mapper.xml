<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="com.leelab.blogproject.post.dao.PostDAO">
	
	<select id="getPostsCount" parameterType="com.leelab.blogproject.post.vo.SearchVO" resultType="int">
		SELECT
			COUNT(*)
		FROM
			BLOG_POST
		<where>
			USER_ID = #{search.user_id}
			<if test="search.main_category_id != 0">
			AND MAIN_CATEGORY_ID = #{search.main_category_id}
			</if>
			<if test="search.sub_category_id != 0">
			AND SUB_CATEGORY_ID = #{search.sub_category_id}
			</if>
		</where>
	</select>
	
	<select id="selectByCategoryId">
		SELECT
			*
		FROM
			BLOG_POST
		WHERE
		<if test='#{type} == "main"'>
			MAIN_CATEGORY_ID = #{param1}
		</if>
		<if test='#{type} == "sub"'>
			SUB_CATEGORY_ID = #{param1}
		</if>
	</select>
	
	<select id="selectById" parameterType="com.leelab.blogproject.post.vo.SearchVO" resultType="com.leelab.blogproject.post.vo.PostVO">
		SELECT 
			POST.*,
			MCATE.NAME AS MAIN_CATEGORY_NAME
			<if test="search.sub_category_id != 0">
			,SCATE.NAME AS SUB_CATEGORY_NAME
			</if>
		FROM
			BLOG_POST POST
			,MAIN_CATEGORY MCATE
			<if test="search.sub_category_id != 0">
			, SUB_CATEGORY SCATE
			</if>
		<where>
			AND POST.ID = #{search.post_id}
			AND MCATE.ID = POST.MAIN_CATEGORY_ID
			<if test="search.sub_category_id != 0">
			AND SCATE.ID = POST.SUB_CATEGORY_ID
			</if>
			<if test="search.main_category_id != 0">
			AND POST.MAIN_CATEGORY_ID = #{search.main_category_id}
			</if>
			<if test="search.sub_category_id != 0">
			AND POST.SUB_CATEGORY_ID = #{search.sub_category_id}
			</if>
		</where>
		ORDER BY
			CREATE_AT DESC
	</select>
	
	<select id="selectPosts" parameterType="hashmap"  resultType="com.leelab.blogproject.post.vo.PostVO">
		SELECT
			*
		FROM
			(SELECT
				PAGE.*, ROWNUM AS RNUM
			 FROM
			 	(SELECT 
					POST.*,
					MCATE.NAME AS MAIN_CATEGORY_NAME,
					CASE POST.SUB_CATEGORY_ID
					WHEN 0
					THEN NULL
					ELSE (SELECT NAME FROM SUB_CATEGORY WHERE ID = POST.SUB_CATEGORY_ID)
					END AS SUB_CATEGORY_NAME
				FROM
					BLOG_POST POST
					,MAIN_CATEGORY MCATE
					<if test="vos.search.sub_category_id != 0">
					, SUB_CATEGORY SCATE
					</if>
				<where>
					AND POST.USER_ID = #{vos.search.user_id}
					AND MCATE.ID = POST.MAIN_CATEGORY_ID
					<if test="vos.search.sub_category_id != 0">
					AND SCATE.ID = POST.SUB_CATEGORY_ID
					</if>
					<if test="vos.search.main_category_id != 0">
					AND POST.MAIN_CATEGORY_ID = #{vos.search.main_category_id}
					</if>
					<if test="vos.search.sub_category_id != 0">
					AND POST.SUB_CATEGORY_ID = #{vos.search.sub_category_id}
					</if>
				</where>
				ORDER BY
					CREATE_AT DESC) PAGE
				<![CDATA[
			  WHERE
			  	ROWNUM <= #{vos.page.currentPage} * 5)
		WHERE
			RNUM > (#{vos.page.currentPage}-1) * 5]]>
	</select>
	
	<insert id="insert" parameterType="com.leelab.blogproject.post.dto.PostDTO">
		INSERT INTO BLOG_POST(
						ID,
  					    USER_ID,
					    TITLE, 
					    MAIN_CATEGORY_ID, 
					    SUB_CATEGORY_ID,
					    CONTENT
					)
					VALUES(
						BLOG_POST_SEQ.NEXTVAL,
						#{user_id},
						#{title},
						#{main_category_id},
						#{sub_category_id},
						#{content}
					)
	</insert>
	
</mapper>